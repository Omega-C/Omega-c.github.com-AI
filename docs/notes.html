

<html>

<head>
	<title>Notes</title>
	<!--This is just a rip off of the console thing I did, but I want something I can jot notes down on nonetheless. Progress will be had later on with replacements and all that jazz.-->
	<style>
	* {
		margin: 0;
		padding: 0;
		outline: 0px solid transparent;
	}
	
	#popup {
		position:absolute;
		width:30%;
		height:40%;
		border: solid black;
		background-color:white;
		border-width: 2px;
		display:none;
	}
	
	#popup>textarea {
		resize: none;
		width:98%;
		height:83%;
		margin:1%;
	}
	#popup>button {
		width:98%;
		height:13%;
		margin:1%;
	}
	
	#main {
		float: left;
		font-family: Consolas, monaco, monospace;
		background-color: #FFFFFF;
		color: black;
		height: calc(95% - 11px);
		width: calc(100% - 10px);
		padding:5px;
		display: inline-block;
		overflow-y: auto;
		white-space: -moz-pre-wrap;
		white-space: -pre-wrap;
		white-space: -o-pre-wrap;
		white-space: pre-wrap;
		word-wrap: break-word;
		font-size: 15px;
	}
	
	button {
		color: #FFFFFF;
		border-radius: 0px;
		font-size: 99%;
		float: left;
		margin: 1px;
		padding: 0px;
		width: calc(20% - 2px);
		height: 5%;
		display: inline-block;
		outline: none;
		border-width: 0px;
		background-color: #7d7e82;
	}
	
	button:active {
		background-color: #5d5f63;
	}
	
	html, body {
		height: 100%;
		margin: 0;
		padding: 0;
		width: 100%;
	}
	</style>
</head>

<body><pre id="main" spellcheck=false contenteditable></pre>
	<div id="popup"><textarea id="replacements" placeholder="JSON for replacements">{"-->":"→","/\\":"∧","\\/":"∨","~!":"¬","<→":"↔","==>":"⇒","--U":"⊃","<⇒":"⇔","=={⇔}":"≡","=={↔}":"≡","D{set}":"𝔻"}</textarea><button onclick="saveParameters();">Save</button></div>
	<button onclick="LoadButton();">Load</button>
	<button onclick="SaveButton();">Save</button>
	<button onclick="download();">Export</button>
	<button onclick="toggle('popup','block')">Replacements</button>
	<button>List Notes</button>


	<script>
	//holy fuck. This is teh worst bodge I've ever made.
	/*https://stackoverflow.com/questions/3972014/get-contenteditable-caret-index-position, https://stackoverflow.com/questions/6249095/how-to-set-caretcursor-position-in-contenteditable-element-div*/
    function getCaretText() {
		var sel = document.getSelection();
		var el = document.getElementById("main")
		sel.modify("extend", "backward", "paragraphboundary");
		var posS = sel.toString();
		if(sel.anchorNode != undefined) sel.collapseToEnd();
		let indexAnchor=0;
		console.log(sel.anchorNode,el.childNodes);
		for (let i=0;i<el.childNodes.length;i++) {
			if (el.childNodes[i]==sel.anchorNode) {
				indexAnchor=i
			}
		}
		if (sel.anchorNode==el) {
			indexAnchor=el.childNodes.length-1;
		}
		return [posS,indexAnchor];
	}
	function setCaret(n,y) {
		var el = document.getElementById("main")
		el.normalize()
		var range = document.createRange()
		var sel = window.getSelection()
		range.setStart(el.childNodes[y],Math.min(n,el.childNodes[y].length))
		range.collapse(true)
		sel.removeAllRanges()
		sel.addRange(range)
	}
	/**/
	let replacementParameters={};
	function saveParameters() {
		try {
			replacementParameters=JSON.parse(document.getElementById("replacements").value)
		} catch(e) {alert("could not parse JSON");alert(e)}
	};
	saveParameters();
	if(localStorage.getItem("savednotes") != null) {
		document.getElementById("main").innerHTML = localStorage.getItem("savednotes")
	};
	if(localStorage.getItem("rewrites") != null) {
		rewritePresets = localStorage.getItem("rewrites")
	} else {
		rewritePresets = ""
	}
	try {
		if(JSON.parse(localStorage.getItem("saves")) === null) {
			localStorage.setItem("saves", JSON.stringify({}))
		}
	} catch(e) {
		console.log("rewriting data I think.");
		localStorage.setItem("saves", JSON.stringify({}))
	};
	document.getElementById("main").addEventListener("paste", function(e) {
		e.preventDefault();
		var text = (e.originalEvent || e).clipboardData.getData('text/plain');
		var element = document.createElement("div");
		element.innerText = text;
		var text = element.innerHTML;
		document.execCommand("insertHTML", false, text)
	});

	function SaveButton() {
		let fname = prompt("file name");
		if(fname == "" || fname == null) {
			return(false)
		};
		let files = JSON.parse(localStorage.getItem("saves"));
		files[fname] = document.getElementById("main").innerHTML;
		localStorage.setItem("saves", JSON.stringify(files))
	};

	function LoadButton() {
		let fname = prompt("file name");
		if(fname == "" || fname == null) {
			return(false);
		};
		let files = JSON.parse(localStorage.getItem("saves"));
		if(!(fname in files)) {
			console.error(`${fname} not found in saves`)
		} else {
			document.getElementById("main").innerHTML = files[fname]
		}
	};

	function download() {
		let a=document.createElement("a");
		a.href=`data:text/html;charset=utf-8,${encodeURIComponent(document.getElementById("main").textContent)}`;
		a.download=prompt("Name of Note: ")+".txt";
		document.body.appendChild(a);
		a.click();
		document.body.removeChild(a);
	};
	
	document.getElementById("main").addEventListener("keydown", function(e) {
		if (String.fromCharCode(e.keyCode).match(/(\w|\d)/g)) {
			let [text, ynode]=getCaretText();
			for (const a in replacementParameters) {
				try {
					text=text.replace(RegExp(a.replace("\\","\\\\")),replacementParameters[a]);
					document.getElementById("main").innerText=document.getElementById("main").innerText.replace(RegExp(a.replace("\\","\\\\")),replacementParameters[a]);
				} catch(e) {
					text=text.replace(a,replacementParameters[a]);
					document.getElementById("main").innerText=document.getElementById("main").innerText.replace(a,replacementParameters[a]);
				}
			};
			setCaret(text.length,ynode);
		}
		localStorage.setItem("savednotes", document.getElementById("main").innerHTML);
		return(false)
	});
	document.getElementById("main").addEventListener("keydown", function replaceTab(event, element = document.activeElement) {
		if(event.key === "Tab") {
			event.preventDefault();
			let selection = window.getSelection();
			let range = selection.getRangeAt(0);
			range.deleteContents();
			let tab = "	";
			let node = document.createTextNode(tab);
			range.insertNode(node);
			selection.modify("move", "right", "character")
		}
	});

	function toggle(elementID,disp) {
		if (document.getElementById(elementID).style.display=="none") {
			document.getElementById(elementID).style.display=disp
		}
		else {
			document.getElementById(elementID).style.display="none"
		}
	};
	</script>
</body>

</html>
